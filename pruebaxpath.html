<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		 <meta http-equiv="X-UA-Compatible" content="IE=edge">
  		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>LECTURA DE FACTURAS XML</title>
		<link rel="stylesheet" href= "css/factxml.css" />
		<script src="js/jquery3/jquery-3.0.0.min.js"></script>
		<script type="text/javascript">
		'use strict';
		(function(){		
			var app=[];
			function llenacelda(reng,conten){
				var celda1 = document.createElement('td');
				reng.appendChild(celda1);
				celda1.appendChild(document.createTextNode(conten))
				return celda1;
			}
			function checatots(reng,stotal,iva,total){
				var checar = parseFloat(stotal)+parseFloat(iva)
				var checarfx= checar.toFixed(2);
				var estacel;
				if(checarfx==total){
						estacel=llenacelda(reng,"OK");
						estacel.style.backgroundColor = 'green';
					}else{
						estacel=llenacelda(reng,"error");
						estacel.style.backgroundColor = 'red';
					}
			}
			function llenareng(cfdi){
			var tabla;
			tabla = document.getElementById("facts")
			var tbody = document.createElement('tbody');
			tbody.setAttribute("id", "lista");
			var cuerpo = document.getElementById("lista");
			tabla.appendChild(tbody);
			var reng= document.createElement('tr'); 
			tbody.appendChild(reng);
			llenacelda(reng,cfdi.fecha);
			llenacelda(reng,cfdi.erfc);
			llenacelda(reng,cfdi.enombre);
			llenacelda(reng,cfdi.serie);
			llenacelda(reng,cfdi.folio);
			llenacelda(reng,cfdi.fpago);
			llenacelda(reng,cfdi.concep);
			llenacelda(reng,cfdi.stotal);
			llenacelda(reng,cfdi.iva);
			llenacelda(reng,cfdi.total);
			checatots(reng,cfdi.stotal,cfdi.iva,cfdi.total),
			llenacelda(reng,cfdi.arch);
			}
			
			function resultado(e,callback){
				var files = e.target.files; // FileList object
					var resul=[];
					for (var i=0, f; f=files[i]; i++) {
				          var r = new FileReader();
			            		r.onload = (function(f) {
			                		return function(e) {
			                			var arch= f.name;
			                    		var contents = e.target.result;

			                    			var resul=leexpath(contents,arch);
			                    			if(resul.exito ==0){
			                    				llenareng(resul);
			                    			}else{
			                    				var mensa = document.getElementById("mensaje");
			                					mensa.value= resul.error;
			                					var mensac = document.getElementById("mensd");
			                					mensac.classList.remove("ocult");
			                					var fecha = new Date();
			                					llenareng(fecha)
			                					
			                    				}

			                				};
			           	 		})(f);

			            r.readAsText(f);
			        } 
			}
			
			function parseXml(xmlStr) {
				   return new window.DOMParser().parseFromString(xmlStr, "text/xml");
				}
			
			function liva(elemento){
				var iva1=0;
				var claseimp = elemento.attributes.getNamedItem("Impuesto").value;
				if(claseimp=="002"){
						iva1=elemento.attributes.getNamedItem("Importe").value;		
					}
				return iva1;
			}
			function leexpath(contenido,arch){
						var exito;
						var cfdi;
						try{
							var nodo =parseXml(contenido);
					 		var nsResolver = nodo.createNSResolver( nodo.ownerDocument == null ? 
					 				nodo.documentElement : nodo.ownerDocument.documentElement);
					 		var path = "/*";
					        var nodes = document.evaluate(path,nodo, nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
							var snap=nodes.snapshotItem(0);
							var lugar = snap.attributes.getNamedItem("LugarExpedicion").value;
							var mpago = snap.attributes.getNamedItem("MetodoPago").value;
							var stotal = snap.attributes.getNamedItem("SubTotal").value;
							var desc= snap.attributes.getNamedItem("Descuento")?snap.attributes.getNamedItem("Descuento").value:"";
							var total = snap.attributes.getNamedItem("Total").value;
							var cstotal= desc==""?stotal:stotal-desc;
							var fpago= snap.attributes.getNamedItem("FormaPago").value;
							var fecha= snap.attributes.getNamedItem("Fecha").value;
							var folio=snap.attributes.getNamedItem("Folio")?snap.attributes.getNamedItem("Folio").value:"";
							var serie= snap.attributes.getNamedItem("Serie")?snap.attributes.getNamedItem("Serie").value:"";
							var version= snap.attributes.getNamedItem("Version").value;
							var elementos= snap.children;
							var emisor = elementos[0];
							var erfc=emisor.attributes.getNamedItem("Rfc").value;
							var enombre=emisor.attributes.getNamedItem("Nombre").value;
							var receptor=elementos[1]
							var concep = elementos[2].children[0].attributes.getNamedItem("Descripcion").value;
							var imptos = elementos[3];
							var traslados = imptos.children[0];
							var trasladosi=traslados.children;
							var iva;
							var traslongi=trasladosi.length;
							for(var i=0;i<traslongi;i++){
								iva = liva(trasladosi[i]);
								if(iva!=0){exito=0;break;}	;
							}
							 cfdi = {
									arch:arch,
								    total:total,
								    stotal:cstotal,
								    fpago:fpago,
								    fecha:fecha,
								    folio:folio,
								    serie:serie,
								    erfc:erfc,
								    enombre:enombre,
								    concep:concep,
								    iva:iva,
								    exito:exito,
								    error:null
								};
						}catch(Exception){
							cfdi={
								exito:-1,
								error: Exception
							}

							
						}
				 		
						return cfdi;
			}
			
			
				$(document).ready(function(){
					var evt = document.getElementById('files');
					  evt.addEventListener('change', function(e){resultado(e,leexpath)},false);
					  app = {
							    isLoading: true,
							    spinner: document.querySelector('.loader'),
							    container: document.querySelector('.main'),
							    addDialog: document.querySelector('.dialog-container'),
							    dmensaje: document.querySelector('.dialog-body')
							  };
					// Muestra aviso de acciones
					  app.toggleAddDialog = function(visible,mensaje=null) {
					    if (visible) {
					      app.addDialog.classList.add('dialog-container--visible');
					      app.dmensaje.innerHTML= mensaje;
					    } else {
					      app.addDialog.classList.remove('dialog-container--visible');
					    }
					  };
					  
					  if (app.isLoading) {
					      app.spinner.setAttribute('hidden', true);
					      app.isLoading = false;
				    }  
					  
				});

		})();
		</script>
	</head>
	<body>
		<h2>LECTURA DE FACTURAS XML XPATH</h2>
			<div align="center">
				<form>
					<div>
						<label for="files">Seleccione la factura</label>
					</div>
					<div>
						<input id="files" name="files" type="file" accept=".xml"/>
					</div>
		
				</form>
			</div>
		<div id="salida">
			<table id="facts">
			<thead>
			<tr><th>Fecha</th><th>RFC</th><th>Nombre</th><th>Serie</th><th>Folio</th><th>Formapago</th>
			<th>Concepto</th><th>Subtotal</th><th>IVA</th><th>Total</th><th>EVAL</th><th>Arch</th></tr>
			</thead>
			</table>
		</div>

		<!-- dialogo aviso -->
		<div class="dialog-container">
			<div class="dialog">
				<div class="dialog-title" id="titulod">AVISO</div>
					<div class="dialog-body"></div>
					<div class="dialog-buttons">
						<button id="okbut" class="button">OK</button>
					</div>
			</div>
		</div>
		
		<div class="loader">
    			<svg viewBox="0 0 32 32" width="32" height="32">
      			<circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
    			</svg>
  		</div>
  		<footer>
  		<button id="enviar">Leer</button>
  		</footer>
	</body>
</html>