<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		 <meta http-equiv="X-UA-Compatible" content="IE=edge">
  		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>LECTURA DE FACTURAS XML</title>
		<link rel="stylesheet" href= "css/factxml.css" />
		<script src="js/jquery3/jquery-3.0.0.min.js"></script>
		<script type="text/javascript">
		'use strict';
		(function(){
		
			var app=[];			
			
			function resultado(e,callback){
				var files = e.target.files; // FileList object
					var resul=[];
					for (var i=0, f; f=files[i]; i++) {
				          var r = new FileReader();
			            		r.onload = (function(f) {
			                		return function(e) {
			                			var arch= f.name;
			                    		var contents = e.target.result;
			                    		var cfdireg;

			                    			var resul=leexpath(contents,arch);
			                    			if(resul.exito ==0){
			                    				llenaforma(resul.fecha,resul.fpago,resul.stotal,resul.iva,resul.total,
			                    				resul.seriefolio,resul.conceptoc)
			                    			}else{
			                    				var mensa = document.getElementById("mensaje");
			                					mensa.value= resul.error;
			                					var mensac = document.getElementById("mensd");
			                					mensac.classList.remove("ocult");
			                					var fecha = new Date();
			                					llenaforma(fecha)
			                					
			                    				}

			                				};
			           	 		})(f);

			            r.readAsText(f);
			        } 
			}
			
			function parseXml(xmlStr) {
				   return new window.DOMParser().parseFromString(xmlStr, "text/xml");
				}
			
			function leexpath(contenido){
				 		var txt = "";
				 		var nodo =parseXml(contenido);
				 		var nsResolver = nodo.createNSResolver( nodo.ownerDocument == null ? 
				 				nodo.documentElement : nodo.ownerDocument.documentElement);
				 		var path2="//Comprobante";
				 		var nodes2 = document.evaluate(path2,nodo,nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);
				 		var snap2=nodes2.snapshotItem(0);
				 		var path = "/*";
				        var nodes = document.evaluate(path,nodo, nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
						var snap=nodes.snapshotItem(0);
						var cfdi =[];
						var lugar = snap.attributes.getNamedItem("LugarExpedicion").value;
						var mpago = snap.attributes.getNamedItem("MetodoPago").value;
						var total = snap.attributes.getNamedItem("Total").value;
						var stotal = snap.attributes.getNamedItem("SubTotal").value;
						var fpago= snap.attributes.getNamedItem("FormaPago").value;
						var fecha= snap.attributes.getNamedItem("Fecha").value;
						var folio= snap.attributes.getNamedItem("Folio").value;
						var serie= snap.attributes.getNamedItem("Serie").value;
						var version= snap.attributes.getNamedItem("Version").value;
						
			}
			
			function datosarch(){
				
			}
			
				$(document).ready(function(){
					var evt = document.getElementById('files');
					  evt.addEventListener('change', function(e){resultado(e,leexpath)},false);
					  app = {
							    isLoading: true,
							    spinner: document.querySelector('.loader'),
							    container: document.querySelector('.main'),
							    addDialog: document.querySelector('.dialog-container'),
							    dmensaje: document.querySelector('.dialog-body')
							  };
					// Muestra aviso de acciones
					  app.toggleAddDialog = function(visible,mensaje=null) {
					    if (visible) {
					      app.addDialog.classList.add('dialog-container--visible');
					      app.dmensaje.innerHTML= mensaje;
					    } else {
					      app.addDialog.classList.remove('dialog-container--visible');
					    }
					  };
					  
					  if (app.isLoading) {
					      app.spinner.setAttribute('hidden', true);
					      app.isLoading = false;
				    }  
					  
				});

		})();
		</script>
	</head>
	<body>
		<h2>LECTURA DE FACTURAS XML XPATH</h2>
			<div align="center">
				<form>
					<div>
						<label for="files">Seleccione la factura</label>
					</div>
					<div>
						<input id="files" name="files" type="file" accept=".xml"/>
					</div>
		
				</form>
			</div>
		<div id="salida">
			<table id="fact">
			</table>
		</div>

		<!-- dialogo aviso -->
		<div class="dialog-container">
			<div class="dialog">
				<div class="dialog-title" id="titulod">AVISO</div>
					<div class="dialog-body"></div>
					<div class="dialog-buttons">
						<button id="okbut" class="button">OK</button>
					</div>
			</div>
		</div>
		
		<div class="loader">
    			<svg viewBox="0 0 32 32" width="32" height="32">
      			<circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
    			</svg>
  		</div>
  		<footer>
  		<button id="enviar">Leer</button>
  		</footer>
	</body>
</html>