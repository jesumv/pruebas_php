<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		 <meta http-equiv="X-UA-Compatible" content="IE=edge">
  		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>PRUEBA REGISTRO DE GASTOS</title>
		<link rel="stylesheet" href= "css/factxml.css" />
		<link rel="stylesheet" type="text/css" href="css/plant1.css">
		<script src="js/jquery3/jquery-3.0.0.min.js"></script>
		<script src="js/fcfdi.js"></script>
		<script type="text/javascript">
		'use strict';
		(function(){
			//bandera que indica si se ha modificado un campo manualmente
			var bandera = 0;
			var app=[];

			function llenaforma(fecha,subtotal="",iva="",total="",factura="",concor=""){
				//llena los campos de la forma con datos xml
				var nfecha = new Date(fecha).toISOString().slice(0,10)
				var forma ={
					nf:document.querySelector('#nfact'),
					fg:document.querySelector('#fgas'),
					mg:document.querySelector('#montog'),
					iva:document.querySelector('#ivag'),
					tg:document.querySelector('#totalg'),
					cg:document.querySelector('#concepo'),
					ctg:document.querySelector('#catg'),
				}
				var f = forma;
				f.nf.value =factura;
				f.nf.disabled = true;
				f.fg.value = nfecha;
				f.fg.disabled = true;
				f.mg.value = subtotal;
				f.mg.disabled = true;
				f.iva.value = iva;
				f.iva.disabled = true;
				f.tg.value = total;
				f.tg.disabled = true;
				f.cg.value = concor;
				f.cg.disabled = true;
				f.ctg.focus();

			}
			function resetea(){
				  //limpia la forma
				document.getElementById('avisor').innerHTML="";
	   			document.getElementById('rgasto').reset();
	   			document.getElementById("mensaje").value = "";
	   			var mensac = document.getElementById("mensd");
	   			mensac.setAttribute('class', 'ocult');
			  }
			function registro(){
				app.toggleAddDialog(false);
				var tabla = document.getElementById("tabla");
				tabla.classList.remove("ocult");
				var no = document.getElementsByTagName("tr").length;
				var concor;
				var row;
				var cell1;
				var cell2;
				var cell3;
				var cell4;
				var cell5;
				var cell6;
				var cell7;
				var cell8
				row = tabla.insertRow();
				cell1 = row.insertCell(0);
				cell2 = row.insertCell(1);
				cell3 = row.insertCell(2);
				cell4 = row.insertCell(3);
				cell5 = row.insertCell(4);
				cell6 = row.insertCell(5);
				cell7 = row.insertCell(6);
				cell8 = row.insertCell(7);
				cell1.innerHTML = no;
				cell2.innerHTML = document.getElementById("fgas").value;
				cell3.innerHTML = document.getElementById("nfact").value;
				cell4.innerHTML = document.getElementById("arch").value;
				var concepval = document.getElementById("concepo").value;
				var errorval = document.getElementById("mensaje").value;
				if(concepval==""){cell5.innerHTML = errorval}else{cell5.innerHTML = concepval;}
				
				cell6.innerHTML = document.getElementById("montog").value;
				cell7.innerHTML = document.getElementById("ivag").value;
				cell8.innerHTML = document.getElementById("totalg").value;
				resetea();
			  }

							
			function listafacturas(e,callback){
				//obtiene arreglo de elementos de caja de lista y los lee como xml
				var files = e.target.files; // FileList object
				var resul=[];
					for (var i=0, f; f=files[i]; i++) {
				          var r = new FileReader();
			            		r.onload = (function(f) {
			                		return function(e) {
			                			var arch= f.name;
			                    		var contents = e.target.result;
			                    		var cfdireg;
			                    		if(bandera == 0){
			                    			var resul=leeXML(contents,arch);
			                    			if(resul.exito ==0){
			                    				llenaforma(resul.fecha,resul.stotal,resul.iva,resul.total,
			                    				resul.seriefolio,resul.conceptoc)
			                    			}else if(resul.exito ==2){
			                    				
			                    			}else{
			                    				var mensa = document.getElementById("mensaje");
			                					mensa.value= resul.error;
			                					var mensac = document.getElementById("mensd");
			                					mensac.classList.remove("ocult");
			                					var fecha = new Date();
			                					llenaforma(fecha)
			                					
			                    				}
			                    			
			                    		}else{document.getElementById("catg").focus();}
			                				};
			           	 		})(f);

			            r.readAsText(f);
			        } 
		      	
				}
			


			
				$(document).ready(function(){
					var evt = document.getElementById('arch');
					  evt.addEventListener('change', function(e){listafacturas(e,leeXML)},false);
					
					function muestrad(){
		   				app.toggleAddDialog(true)
		   				document.getElementById('fgas').focus();
		   			}

					  app = {
							    isLoading: true,
							    spinner: document.querySelector('.loader'),
							    container: document.querySelector('.main'),
							    addDialog: document.querySelector('.dialog-container'),
							  };
					  
					  app.toggleAddDialog = function(visible) {
					    if (visible) {
					      app.addDialog.classList.add('dialog-container--visible');
					    } else {
					      app.addDialog.classList.remove('dialog-container--visible');
					    }
					  };
					  
					  if (app.isLoading) {
					      app.spinner.setAttribute('hidden', true);
					      app.isLoading = false;
				    } 
					  
					  function cuentasi(){
			   				//esta funcion pone el numero de cuenta default
			   				var cuenta = document.getElementById("cuenta");
			   				var elec = document.getElementById("smpago").value;
			   				switch(elec){
			   				case "02":
			   				case "03":
			   					cuenta.value='8145';
			   				break;
			   				case "04":
			   					cuenta.value='8886';
			   				break;
			   				case "28":
			   				cuenta.value='2730';
			   				break;
			   				}
			   				cuenta.focus();
			   			}
					  
					  function calciva(){
			   				var valor=document.getElementById("montog").value;
			   				var ivac=valor*.16;
			   				var civa=document.getElementById("ivag");
			   				civa.value= ivac.toFixed(2);
			   				calctotal();
			   				civa.focus();
			   				bandera = 1;
			   			}
					  
					  function calctotal(){
			   				var base = document.getElementById("montog").value;
			   				var iva = document.getElementById("ivag").value;
			   				var total = Number(base) + Number(iva);
			   				var ctotal = document.getElementById("totalg");
			   				ctotal.value = total.toFixed(2);
			   				document.getElementById("catg").focus();
			   			}
					  
					  function cancela(){
			   				app.toggleAddDialog(false)
			   				resetea();
			   				
			   			}
					  
					  
					  
					  //escuchas
						document.getElementById("botonp").addEventListener('click',muestrad,false)
						document.getElementById("smpago").addEventListener('change',cuentasi,false)
						//calculo de iva
						document.getElementById("montog").addEventListener('change',calciva,false)
						document.getElementById("reggasto").addEventListener('click',registro,false)
						document.getElementById("butAddCancel").addEventListener('click',cancela,false)
				});

		})();
		</script>
	</head>
	<body>
		<h2>PRUEBA DE GASTO XML</h2>
<div	 class = "main">
	<div class="botoncent">
				  	<button class="button c" type="button" id="botonp">Registrar Gasto</button>
	</div>
</div>
<div id="dtabla" >
	<table id="tabla" class="ocult">
	<tr><th>no.</th><th>fecha</th><th>factura</th><th>arch</th><th>concor</th><th>subtotal</th><th>iva</th><th>total</th></tr>
	</table>
</div>
				 <!-- caja dialogo registro pago -->
		  <div class="dialog-container"  id="dialogog">
		    <div class="dialog">
		    	<div class="dialog-title" id="titulod">REGISTRO DE GASTO</div>
		    	<div id="mensd" class="rengn ocult">
		    	<label>MENSAJES: </label>
		    	<textarea name="mensaje"  id="mensaje" rows="4" cols="50"></textarea>
		    	</div>
			    	<div class="dialog-body">
			    		<form id="rgasto" method ="post" action="#" onsubmit="return false;">
			    			<div class="rengn">
						    	<label>Archivo XML: </label><input type="file" name="arch"  id="arch" accept=".xml"/>
						    	<label>Factura: </label><input type="text" name="nfact"  id="nfact" class="cajamfc"/>
						    	<label>Fecha: </label><input type="date" name="fgas"  id="fgas" class="cajacfc"/>
					    	</div>
			    			<div class="rengn">
			    			<label>Subtotal:</label><input type="text" name="montog" id="montog"/>
			    			<label>Iva:</label><input type="text" name="ivag" id="ivag" size="10" class="cajacfc"/>
			    			<label>TOTAL:</label><input type="text" name="totalg" id="totalg" disabled="TRUE"/>
			    			</div>
			    			<div	 class="rengn">
			    			<label>Concepto Orig: </label><input type="text" name="concepo"  id="concepo" class="cajalfc"/>
			    			</div>
			    			<div class="rengn">
			    				<label>Categoría: </label>
			    				<select id="catg" name="catg">
									<option value="0">Seleccione la clase de gasto</option>
									<option value="01">Gastos Generales</option>
									<option value="02">Gastos de Venta</option>
									<option value="03">Gastos de Administración</option>
									<option value="04">Gastos Financieros</option>
									<option value="05">Reembolso de Gastos</option>
									<option value="99">Otros Gastos</option>
		         				</select>
		         				<label>Concepto: </label><input type="text" name="concepg"  id="concepg" class="cajam" maxlength="20"/>		
			    			</div>
			    			<label>Metodo de Pago: </label>
			    			<div class="rengn">
			    				<select id="smpago" name="smpago">
									<option value="0">Seleccione el medio de pago</option>
									<option value="01">Efectivo</option>
									<option value="02">Cheque</option>
									<option value="03">Transferencia</option>
									<option value="04">Tarjetas de Credito</option>
									<option value="28">Tarjetas de Débito</option>
									<option value="99">Otros</option>
		         				</select>
		         				<label>Cuenta: </label><input type="text" name="cuenta"  id="cuenta" class="cajac" maxlength="4" />
		         				<label>Folio Op: </label><input type="text" name="folio"  id="folio" class="cajac" />
			    			</div>
			    			<div class="rengn">
			    				<h4 id="avisor"></h4>
			    			</div>
			    			<div class="dialog-buttons">
			    				<button type="submit" id="reggasto" class="button a">Registrar</button>
						      	<button type="submit" id="butAddCancel" class="button b" >Cancelar</button>
						    </div>
			    		</form>
			    	</div>
		    </div>
		  </div>

		
		<div class="loader">
    			<svg viewBox="0 0 32 32" width="32" height="32">
      			<circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
    			</svg>
  		</div>
  		<footer>
  		</footer>
	</body>
</html>