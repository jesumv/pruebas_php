<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
			 <meta http-equiv="X-UA-Compatible" content="IE=edge">
	  		<meta name="viewport" content="width=device-width, initial-scale=1.0">
			<title>CARGA MASIVA DE FACTURAS GASTOS</title>
			<link rel="stylesheet" href= "css/factxml.css" />
			<script src="js/fcfdiv3.js"></script>
			<script src="js/jquery3/jquery-3.3.1.min.js"></script>
			<script type="text/javascript">
			'use strict';
			(function(){
				var app=[];
				function addpie(){
					var dpie = document.getElementById('pie');
					var benvia = document. createElement("button");
					benvia.innerHTML = "Enviar Facturas";
					benvia.id="enviar";
					dpie.appendChild(benvia);
				}
				function addcabezal(){
					var dbody = document.getElementById('dtabla');
					var tbl = document.createElement('table');
					tbl.setAttribute("id", "lista");
					var reng0 = document.createElement('tr');
					var reng1 = document.createElement('tr');
					reng0.setAttribute("id", "re0");
					reng1.setAttribute("id", "re1");
					for(var i=0; i<14; i++){
						var celda = document.createElement('th');
						celda.setAttribute("id", "cl"+i);
						reng0.appendChild(celda);
					}
					tbl.appendChild(reng0);
					var celda = [];
					for(var i=0; i<14; i++){
						celda[i] = document.createElement('td');
						celda[i].setAttribute("id", "2cl"+i);
						reng1.appendChild(celda[i]);
					}
					celda[0].innerHTML = "No.";
					celda[1].innerHTML = "FECHA";
					celda[2].innerHTML = "RAZON SOCIAL";
					celda[3].innerHTML = "RFC";
					celda[4].innerHTML = "SERIE";
					celda[5].innerHTML = "FOLIO";
					celda[6].innerHTML = "CONCEPTO";
					celda[7].innerHTML = "SUBTOTAL";
					celda[8].innerHTML = "IVA";
					celda[9].innerHTML = "TOTAL";
					celda[10].innerHTML = "Arch.";
					celda[11].innerHTML = "D Mens";
					celda[12].innerHTML = "D Anual";
					celda[13].innerHTML = "Abrir";
					tbl.appendChild(reng1);
					dbody.appendChild(tbl)
					var feld = document.createElement("input");
					feld.setAttribute("type","checkbox");
					feld.id="cktodas"
					var celmar = document.getElementById('cl11');
					var etiq = document.createElement("Label");
                    etiq.htmlFor = "cktodas";
                    etiq.setAttribute("for","cktodas");
                    etiq.innerHTML="Elige todas";
                	celmar.appendChild(etiq);
					celmar.appendChild(feld);
				}
				function llenareng(fecha,rfc,nombre,concep,stotal,total,narch,iva=null,serie = null,folio = null){
					//llena un renglon de la tabla
					var tabla = document.getElementById("lista");
					var no = document.getElementsByTagName("tr").length-1;
					var row;
					var cell1;
					var cell2;
					var cell3;
					var cell4;
					var cell5;
					var cell6;
					var cell7;
					var cell8;
					var cell9;
					var cell10;
					var cell11;
					var cell12;
					var cell13;
					var cell14;
					var totm =parseFloat(stotal).toFixed(2);
					var totm2 =parseFloat(total).toFixed(2);
					var ivam;
					if(iva!=""){ivam =parseFloat(iva).toFixed(2)}else{ivam="0.00"};
						row = tabla.insertRow();
						cell1 = row.insertCell(0);
						cell2 = row.insertCell(1);
						cell3 = row.insertCell(2);
						cell4 = row.insertCell(3);
						cell5 = row.insertCell(4);
						cell6 = row.insertCell(5);
						cell7 = row.insertCell(6);
						cell8 = row.insertCell(7);
						cell9 = row.insertCell(8);
						cell10 = row.insertCell(9);
						cell11 = row.insertCell(10);
						cell12 = row.insertCell(11);
						cell13 = row.insertCell(12);
						cell14 = row.insertCell(13);
						cell1.innerHTML = no;
						cell2.innerHTML = fecha;
						cell3.innerHTML = nombre;
						cell4.innerHTML = rfc; 
						cell5.innerHTML = serie;
						cell6.innerHTML = folio;
						cell7.innerHTML = concep;
						cell8.innerHTML = totm;
						cell9.innerHTML = ivam;
						cell10.innerHTML = totm2;
						cell11.innerHTML = narch;
						var feld = document.createElement("input");
						var feld2 = document.createElement("input");
						feld.setAttribute("type","checkbox");
						feld.setAttribute("class","cdmens"); 
						feld2.setAttribute("type","checkbox");
						feld2.setAttribute("class","cdanual");
						cell12.appendChild(feld);
						cell13.appendChild(feld2);			
				};
				function listafacturas(e,callback){
					//obtiene arreglo de elementos de caja de lista y los lee como xml
					var files = e.target.files; // FileList object
					var resul;
					var datos;
						for (var i=0, f; f=files[i]; i++) {
					          var r = new FileReader();
				            		r.onload = (function(f) {
				                		return function(e) {
				                			var arch= f.name;
				                    		var contents = e.target.result;
				                   		datos=leeXMLing(contents);
				                   		//si el tipo de comprobante es pago, ignora el renglon
				                   		if(datos.tipoc=="I"){
				                   			llenareng(datos.fecha,datos.rfc,datos.nombre,datos.conceptoc,
							                datos.stotal,datos.total,arch,datos.iva,datos.serie,datos.folio);
				                   		}			                   		
				                				};
				           	 		})(f);

				            r.readAsText(f);
				        } 
			      	
					}
				function sacadato(arreglo){
					var arrtemp=[];
					//obtiene los valores del array de elementos
					for(var i=1; i<11;i++){
						arrtemp.push(arreglo.item(i).innerHTML);
					}
					return arrtemp;
				}
				
				function envialista(){
					//esta funcion recolecta la informacion y la envia a la bd
					//coleccion de renglones
					var nofac = document.getElementsByTagName("tr");
					var nodos;
					var opr;
					var longi = nofac.length;
					//arreglo de resultados
					var result1=[];
					for(var i=2; i<longi;i++){		
						 nodos = nofac.item(i).childNodes;
						opr =nodos.item(11).childNodes;
						if(opr.item(0).checked==true){
								result1.push(sacadato(nodos));
							
						}
					}
					var arrmod= JSON.stringify(result1);
					$.post('php/enviafacts.php', { 'result1':arrmod }, function(data){
						app.toggleAddDialog.visible=true;
						})
						.done(function(){
							alert("Facturas en BD Mes OK");
						})
						.fail(function(){
							alert("PROBLEMA EN INSERCION FACTURAS");
						});
						
				}
				
				function marcatodas(){
					//esta funcion marca todos los check de dmensual
				var todas = document.getElementsByClassName('cdmens');
					for (var i = 0; i < todas.length; ++i) {
					    var item = todas[i];  
					    item.checked = true;
					}	
				}
				$(document).ready(function(){
					addcabezal();
					addpie();
					document.getElementById('enviar').addEventListener('click',envialista)
					var evt = document.getElementById('files');
					
					//oculta el dialogo de aviso
					  document.getElementById('okbut').addEventListener('click', function() {
						    // oculta el dialogo
						    app.toggleAddDialog(false);
						  });
					 evt.addEventListener('change', function(e){listafacturas(e,leeXML)},false);
					//escucha del check marcar todas
						var cktodas = document.getElementById('cktodas');
						 cktodas.addEventListener('change', function(){
							 if(this.checked){marcatodas()}
						 });
					 app = {
							    isLoading: true,
							    spinner: document.querySelector('.loader'),
							    addDialog: document.querySelector('.dialog-container'),
							    dmensaje: document.querySelector('.dialog-body')
							  };
					// Muestra aviso de acciones
					  app.toggleAddDialog = function(visible,mensaje=null) {
					    if (visible) {
					      app.addDialog.classList.add('dialog-container--visible');
					      app.dmensaje.innerHTML= mensaje;
					    } else {
					      app.addDialog.classList.remove('dialog-container--visible');
					    }
					  };
					  if (app.isLoading) {
					      app.spinner.setAttribute('hidden', true);
					      app.isLoading = false;
				    }  
				});
				
			})();
			</script>
			
			
	</head>
	<body id='cuerpo'>
		<header>
		<h2>CARGA MASIVA DE GASTOS CON FACTURAS XML</h2>
		<div align="center">
				<form>
					<div>
						<label for="files">Seleccione las facturas</label>
					</div>
					<div>
						<input id="files" name="files[]" type="file" accept=".xml" multiple/>
					</div>
		
				</form>
			</div>
		</header>
		<div id="dtabla"></div>
		<!-- dialogo aviso -->
		<div class="dialog-container">
			<div class="dialog">
				<div class="dialog-title" id="titulod">AVISO</div>
					<div class="dialog-body"></div>
					<div class="dialog-buttons">
						<button id="okbut" class="button">OK</button>
					</div>
			</div>
		</div>
		
		<div class="loader">
    			<svg viewBox="0 0 32 32" width="32" height="32">
      			<circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
    			</svg>
  		</div>
		<footer id='pie' align="center">
		</footer>

	</body>
</html>
	