<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		 <meta http-equiv="X-UA-Compatible" content="IE=edge">
  		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>PRUEBAS CON XML ver 2</title>
		<link rel="stylesheet" href= "css/factxml.css" />
		<script src="js/jquery3/jquery-3.0.0.min.js"></script>
		<script type="text/javascript">
		'use strict';
		(function(){
			var app=[];		
			function getver(xmlDoc){
				var versiona= xmlDoc.getNamedItem("Version")
				var version
				if(!versiona)
				{
					version = xmlDoc.getNamedItem("version").nodeValue
				}else{
					 version = xmlDoc.getNamedItem("Version").nodeValue;
				}
				
				return version
			}
			
			function llenareng(fecha,rfc,nombre,concep,stotal,total,narch,iva=null,serie = null,folio = null){
				//llena un renglon de la tabla
				var tabla = document.getElementById("lista");
				var no = document.getElementsByTagName("tr").length;
				var row;
				var cell1;
				var cell2;
				var cell3;
				var cell4;
				var cell5;
				var cell6;
				var cell7;
				var cell8;
				var cell9;
				var cell10;
				var cell11;
				var cell12;
				var cell13;
				var cell14;
				var totm =parseFloat(stotal).toFixed(2);
				var totm2 =parseFloat(total).toFixed(2);
				var ivam;
				if(iva!=""){ivam =parseFloat(iva).toFixed(2)}else{ivam="0.00"};
					row = tabla.insertRow();
					cell1 = row.insertCell(0);
					cell2 = row.insertCell(1);
					cell3 = row.insertCell(2);
					cell4 = row.insertCell(3);
					cell5 = row.insertCell(4);
					cell6 = row.insertCell(5);
					cell7 = row.insertCell(6);
					cell8 = row.insertCell(7);
					cell9 = row.insertCell(8);
					cell10 = row.insertCell(9);
					cell11 = row.insertCell(10);
					cell12 = row.insertCell(11);
					cell13 = row.insertCell(12);
					cell14 = row.insertCell(13);
					cell1.innerHTML = no;
					cell2.innerHTML = fecha;
					cell3.innerHTML = nombre;
					cell4.innerHTML = rfc; 
					cell5.innerHTML = serie;
					cell6.innerHTML = folio;
					cell7.innerHTML = concep;
					cell8.innerHTML = totm;
					cell9.innerHTML = ivam;
					cell10.innerHTML = totm2;
					cell11.innerHTML = narch;
					var feld = document.createElement("input");
					var feld2 = document.createElement("input");
					feld.setAttribute("type","checkbox"); 
					feld2.setAttribute("type","checkbox");
					cell12.appendChild(feld)
					cell13.appendChild(feld2)			
			};
			
			function checarecep(rfc){
				var resul;
				//revisa que la factura sea para receptor correcto
				var recepo = "MAVJ621021AQA";
				if(rfc == recepo){
					resul = 0;
				}else{
					resul= -1;
				}
				return resul;
			}
			
			function leeserief(version,comprob){
				//lee serie y folio dependiendo de version, si los tiene
				var serie;
				var folio32 = comprob.getNamedItem("folio");
				var serie32= comprob.getNamedItem("serie");
				var folio33 = comprob.getNamedItem("Folio");
				var serie33= comprob.getNamedItem("Serie");
				var resul =[];
				if (version == "3.3"){
					if(serie33){resul["serie"] = comprob.getNamedItem("Serie").nodeValue}else{resul["serie"] = ""};
					if(folio33){resul["folio"] = comprob.getNamedItem("Folio").nodeValue}else{resul["folio"] = ""};
				}else{
					if(serie32){resul["serie"] = comprob.getNamedItem("serie").nodeValue}else{resul["serie"] = ""};
					if(folio32){resul["folio"] = comprob.getNamedItem("folio").nodeValue}else{resul["folio"] = ""};
				}
				return resul;
			}
			function capiva(version,xdoc){
				var iva
				//buscar definiciones de iva
				var imp = xdoc.getElementsByTagName("cfdi:Impuestos");
				var totimptr =xdoc.getElementsByTagName("totalImpuestosTrasladados");
				if(imp.length ==0){
					iva = 0;
				}else{
					var novacio = imp[0].hasChildNodes();
					if(novacio){
						//s√≠ hay datos en el nodo impuestos
						var totalimp = imp[0].attributes;
						if(totalimp.length!=0){
							//si existe el atributo de total impuestos
							iva = totalimp.getNamedItem("totalImpuestosTrasladados").nodeValue;
						}else{
							
							//si no hay total, se busca por nodo
							//definicion de etiqueta a buscar
							var etiq;
							var etiq2;
							var nomimp;
							var ntasa;
							if(version=="3.2"){
								etiq= "impuesto";
								etiq2="importe";
								nomimp="IVA";
								ntasa ="tasa";
								}else{
									etiq= "Impuesto";
									etiq2="Importe";
									nomimp = "002"
									ntasa = "TasaOCuota"
									}
							var traslado = xdoc.getElementsByTagName("cfdi:Traslado");
							for (var i=0; traslado.length; i++){
								var atribs = traslado[i].attributes;
								var nomtem = atribs.getNamedItem(etiq).nodeValue
								if(nomtem == nomimp){
									var haytasa = atribs.getNamedItem(ntasa);
									if(haytasa){
										var tasa = atribs.getNamedItem(ntasa).nodeValue
										if(tasa.includes("16")){iva = atribs.getNamedItem(etiq2).nodeValue; break;}else{iva="0"; break;}
										
									}else{
										iva="0"; break;
									}
										
									
									}
							}
						}
						
					}else{
						//si no hay datos
						iva = ""
					}
				}
		
				return iva;
			}
		
			//this will parse XML file and output it to website
			function leeXML(text,narch) {
				var xmlDoc
				try{
					xmlDoc = $.parseXML(text);
					var comprob = xmlDoc.getElementsByTagName("cfdi:Comprobante")[0].attributes;
					var version = getver(comprob);
					var datosf = leeserief(version,comprob);
					var emisor = xmlDoc.getElementsByTagName("cfdi:Emisor")[0].attributes;
					var receptor = xmlDoc.getElementsByTagName("cfdi:Receptor")[0].attributes;
					var concepto =xmlDoc.getElementsByTagName("cfdi:Concepto")[0].attributes;
					var fecha;
					var iva 
					var concepa ;
					var concepa1;
					var concep;
					var stotal;

					var total;
					var rfc
					var nombre
					var nombrea
					var rfcrecep
					if (version == "3.3"){					 
						 var haydescu = comprob.getNamedItem("Descuento");
						 //si hay descuento se modifica subtotal
						 if(haydescu){
							 var descu = comprob.getNamedItem("Descuento").nodeValue;
							 stotal = comprob.getNamedItem("SubTotal").nodeValue - descu;
						 }else{
							 stotal = comprob.getNamedItem("SubTotal").nodeValue	 
						 };
						 total = comprob.getNamedItem("Total").nodeValue
						 fecha= comprob.getNamedItem("Fecha").nodeValue
						 iva = capiva(version,xmlDoc);
						 rfc = emisor.getNamedItem("Rfc").nodeValue;
						 nombrea=emisor.getNamedItem("Nombre");
						 if(nombrea){nombre = nombrea.nodeValue}else{nombre="SIN NOMBRE"};
						 rfcrecep =receptor.getNamedItem("Rfc").nodeValue;
						 concepa = concepto.getNamedItem("Descripcion");
						 concep = concepa.nodeValue
					}else {
						try{stotal = comprob.getNamedItem("subTotal").nodeValue;}catch(err){stotal= "ERROR STOTAL"}
						total = comprob.getNamedItem("total").nodeValue
						fecha= comprob.getNamedItem("fecha").nodeValue
						rfc = emisor.getNamedItem("rfc").nodeValue;
						 nombrea=emisor.getNamedItem("nombre")
						 
						 if(nombrea){nombre = nombrea.nodeValue}else{nombre="SIN NOMBRE"};
						rfcrecep =receptor.getNamedItem("rfc").nodeValue;
						concepa = concepto.getNamedItem("descripcion");
						concep = concepa.nodeValue
					}
					//validar que el receptor sea el correcto
					var recep = checarecep(rfcrecep);
					//si lo es, se llena un renglon					
					//si no, se presenta el aviso
					var cmensaje= "<p>RECEPTOR INVALIDO</p><p>FACTURA "+datosf["serie"]+" "+datosf["folio"]+"</p><p>"+nombre+"</p><p>NO SE INCLUYE</p>"
					if(recep==0){llenareng(fecha,rfc,nombre,concep,stotal,total,narch,iva,datosf["serie"],datosf["folio"]);}
					else{app.toggleAddDialog(true,cmensaje)}
				
				}catch(err){
					fecha = new Date()
					llenareng(fecha,"ERROR","FORMATO INVALIDO","",0,0,narch,"","","")
				}
					
			};
			
			
			
			function listafacturas(e,callback){
				//obtiene arreglo de elementos de caja de lista y los lee como xml
				var files = e.target.files; // FileList object
				var resul;
					for (var i=0, f; f=files[i]; i++) {
				          var r = new FileReader();
			            		r.onload = (function(f) {
			                		return function(e) {
			                			var arch= f.name;
			                    		var contents = e.target.result;
			                   		leeXML(contents,arch);
			                				};
			           	 		})(f);

			            r.readAsText(f);
			        } 
		      	
				}
			
			function sacadato(arreglo){
				var arrtemp=[];
				//obtiene los valores del array de elementos
				for(var i=1; i<11;i++){
					arrtemp.push(arreglo.item(i).innerHTML);
				}
				return arrtemp;
			}
			function envialista(){
				//esta funcion recolecta la informacion y la envia a la bd
				//coleccion de renglones
				var nofac = document.getElementsByTagName("tr");
				var nodos;
				var opr;
				var longi = nofac.length;
				//arreglo de resultados
				var result1=[];
				for(var i=1; i<longi;i++){		
					 nodos = nofac.item(i).childNodes;
					opr =nodos.item(11).childNodes;
					if(opr.item(0).checked==true){
							result1.push(sacadato(nodos));
						
					}
				}
				var arrmod= JSON.stringify(result1);
				$.post('php/enviafacts.php', { 'result1':arrmod }, function(data){
					app.toggleAddDialog.visible=true;
					})
					.done(function(){
						alert("exito2");
					})
					.fail(function(){
						alert("fracaso");
					});
					
			}
				$(document).ready(function(){
					document.getElementById('enviar').addEventListener('click',envialista)
					var evt = document.getElementById('files');
					//oculta el dialogo de aciso
					  document.getElementById('okbut').addEventListener('click', function() {
						    // oculta el dialogo
						    app.toggleAddDialog(false);
						  }); 
					evt.addEventListener('change', function(e){listafacturas(e,leeXML)},false);
					  app = {
							    isLoading: true,
							    spinner: document.querySelector('.loader'),
							    container: document.querySelector('.main'),
							    addDialog: document.querySelector('.dialog-container'),
							    dmensaje: document.querySelector('.dialog-body')
							  };
					// Muestra aviso de acciones
					  app.toggleAddDialog = function(visible,mensaje=null) {
					    if (visible) {
					      app.addDialog.classList.add('dialog-container--visible');
					      app.dmensaje.innerHTML= mensaje;
					    } else {
					      app.addDialog.classList.remove('dialog-container--visible');
					    }
					  };
					  
					  if (app.isLoading) {
					      app.spinner.setAttribute('hidden', true);
					      app.isLoading = false;
				    }  
					  
				});

		})();
		</script>
	</head>
	<body>
		<h2>PRUEBAS CON ARCHIVOS XML</h2>
			<div align="center">
				<form>
					<div>
						<label for="files">Seleccione las facturas</label>
					</div>
					<div>
						<input id="files" name="files[]" type="file" accept=".xml" multiple/>
					</div>
		
				</form>
			</div>
		<div id="list">
			<table id="lista">
			 <tr><th>NO.</th><th>FECHA</th><th class="rfc">RAZON SOCIAL</th><th>RFC</th><th class="serie">SERIE</th><th class="folio">FOLIO</th>
			<th>CONCEPTO</th><th class="total">SUBTOTAL</th><th>IVA</th><th>TOTAL</th><th>ARCH</th><th>D MENS</th><th>D ANUAL</th><th>abrir</th></tr>
			</table>
		</div>
		<!-- dialogo aviso -->
		<div class="dialog-container">
			<div class="dialog">
				<div class="dialog-title" id="titulod">AVISO</div>
					<div class="dialog-body"></div>
					<div class="dialog-buttons">
						<button id="okbut" class="button">OK</button>
					</div>
			</div>
		</div>
		
		<div class="loader">
    			<svg viewBox="0 0 32 32" width="32" height="32">
      			<circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
    			</svg>
  		</div>
  		<footer>
  		<button id="enviar">Enviar</button>
  		</footer>
	</body>
</html>